<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Checkout | Olasunkanmi Salami</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <link rel="shortcut icon" href="plogo.png" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <style>
    body { font-family: 'Montserrat', sans-serif; background: #fff; color: #111; }
    .btn-primary { background-color:#D2B48C; color:#fff; padding:10px 14px; border-radius:8px; display:inline-block; text-decoration:none; }
    .muted { color:#666; }
    .card { background:#f8fafb; border-radius:10px; padding:18px; }
    /* small toast container style */
    #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display:flex; flex-direction:column; gap:8px; pointer-events:none; }
    .toast { pointer-events:auto; background:rgba(0,0,0,0.85); color:white; padding:8px 12px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.25); }
  </style>
</head>
<body class="bg-white text-black">
  <nav class="py-6 px-6 md:px-12 lg:px-24 flex items-center justify-between">
    <div class="flex items-center gap-3 font-bold text-lg">
      <img src="plogo.png" alt="logo" class="h-10 w-10 object-contain">
      Olasunkanmi Salami's Publication
    </div>
    <div class="flex items-center gap-4">
      <a href="publications.html" class="muted">Publications</a>
      <a href="index.html" class="muted">Home</a>
    </div>
  </nav>

  <section class="py-10 px-6 md:px-12 lg:px-24">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-6">Complete Your Purchase</h1>

      <div class="flex flex-col lg:flex-row gap-10">
        <!-- left: order + payment -->
        <div class="lg:w-2/3 space-y-6">
          <div class="card">
            <h2 class="text-xl font-bold mb-4">Order Summary</h2>
            <div id="order-items" class="space-y-4"></div>

            <div class="mt-4 border-t border-gray-200 pt-4">
              <div class="flex justify-between mb-2"><span>Subtotal</span><span id="subtotal">₦0.00</span></div>
              <div class="flex justify-between mb-2"><span>Tax</span><span id="tax">₦0.00</span></div>
              <div class="flex justify-between font-bold text-lg pt-3"><span>Total</span><span id="total">₦0.00</span></div>
            </div>
          </div>

          <div class="card">
            <h2 class="text-xl font-bold mb-4">Payment</h2>

            <!-- Minimal payment area: only email + Paystack button -->
            <div class="mb-4">
              <label class="block mb-2 font-medium">Email (required)</label>
              <input id="customer-email" type="email" class="w-full px-4 py-2 border rounded" placeholder="you@example.com">
            </div>

            <div class="flex gap-3 items-center">
              <button id="pay-btn" class="btn-primary" type="button">Pay with Paystack</button>
              <a href="publications.html" class="px-4 py-2 border rounded text-sm">Continue shopping</a>
            </div>
            <div id="payment-msg" class="mt-3 muted text-sm"></div>
          </div>
        </div>

        <!-- right: download instructions -->
        <div class="lg:w-1/3">
          <div class="card sticky top-8">
            <h2 class="text-xl font-bold mb-3">Download Instructions</h2>
            <p class="mb-3 muted">After your payment is verified you'll receive instant downloads on this page and (if provided) an email with download links.</p>
            <p class="mb-3">Files can be delivered as direct PDF downloads (PDF/EPUB/MOBI) — ensure your files are hosted where browsers can fetch them.</p>

            <div class="mt-4 space-y-2">
              <div class="flex items-center gap-2"><i data-feather="check-circle" class="text-green-500"></i><span>DRM-Free</span></div>
              <div class="flex items-center gap-2"><i data-feather="check-circle" class="text-green-500"></i><span>Unlimited Downloads</span></div>
              <div class="flex items-center gap-2"><i data-feather="check-circle" class="text-green-500"></i><span>Customer Support</span></div>
            </div>
            <div class="mt-6 text-sm muted">Note: For production always verify payment on your server before granting files.</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer class="py-8 px-6 md:px-12 lg:px-24 bg-black text-white">
    <div class="max-w-4xl mx-auto flex justify-between items-center">
      <div>© 2025 Olasunkanmi Salami's Publication</div>
      <div class="flex gap-4">
        <!-- <a href="#" class="text-white"><i data-feather="twitter"></i></a></div> -->
        
    </div>
  </footer>

  <div id="toast-container" aria-hidden="true"></div>

  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script>
    feather.replace();

    const CART_KEY = 'olasunkanmi_cart_v1';
    function readCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); } catch(e){ return []; } }
    function clearCart(){ localStorage.removeItem(CART_KEY); updateUIAfterClear(); }

    function updateUIAfterClear(){
      // simple UI updates after cart cleared
      document.getElementById('order-items').innerHTML = '<div class="py-6 text-center muted">Your cart is empty — <a href="publications.html">Go back</a></div>';
      document.getElementById('subtotal').textContent = '₦0.00';
      document.getElementById('tax').textContent = '₦0.00';
      document.getElementById('total').textContent = '₦0.00';
      document.getElementById('pay-btn').disabled = true;
    }

    // small toast helper
    function showToast(msg) {
      const container = document.getElementById('toast-container');
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      container.appendChild(t);
      setTimeout(()=> { t.style.transition = 'opacity 220ms'; t.style.opacity = '0'; }, 1400);
      setTimeout(()=> t.remove(), 1700);
    }

    // Render order items from localStorage
    function renderOrder() {
      const items = readCart();
      const list = document.getElementById('order-items');
      const subtotalEl = document.getElementById('subtotal');
      const taxEl = document.getElementById('tax');
      const totalEl = document.getElementById('total');

      list.innerHTML = '';
      if (!items || items.length === 0) {
        list.innerHTML = '<div class="py-6 text-center muted">Your cart is empty — <a href="publications.html">Go back</a></div>';
        document.getElementById('pay-btn').disabled = true;
        subtotalEl.textContent = '₦0.00';
        taxEl.textContent = '₦0.00';
        totalEl.textContent = '₦0.00';
        return;
      }

      let subtotal = 0;
      items.forEach(it => {
        const price = parseFloat(it.price || 0);
        const qty = parseInt(it.qty || 1, 10);
        subtotal += price * qty;

        const row = document.createElement('div');
        row.className = 'flex justify-between items-center';
        row.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="${it.thumb || 'book1.jpg'}" alt="" class="w-12 h-12 object-cover rounded">
            <div>
              <div class="font-medium">${escapeHtml(it.title)}</div>
              <div class="text-sm muted">${qty} × ₦${price.toFixed(2)}</div>
            </div>
          </div>
          <div class="font-bold">₦${(price*qty).toFixed(2)}</div>
        `;
        list.appendChild(row);
      });

      const tax = 0.00; // add logic if you need tax
      const total = subtotal + tax;
      subtotalEl.textContent = `₦${subtotal.toFixed(2)}`;
      taxEl.textContent = `₦${tax.toFixed(2)}`;
      totalEl.textContent = `₦${total.toFixed(2)}`;
      document.getElementById('pay-btn').disabled = false;
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    renderOrder();

    // PAYSTACK FLOW (simplified: public key in client)
    document.getElementById('pay-btn').addEventListener('click', function() {
      const cart = readCart();
      if (!cart.length) return alert('Cart is empty');
      const email = (document.getElementById('customer-email').value || '').trim();
      if (!email) {
        document.getElementById('payment-msg').textContent = 'Please enter your email.';
        return;
      }
      const total = cart.reduce((s,i) => s + (parseFloat(i.price||0) * (i.qty||1)), 0);
      const amountKobo = Math.round(total * 100); // Naira -> kobo (Paystack expects smallest unit)

      // NOTE: replace with your Paystack public key (pk_test_... or pk_live_...)
      const PAYSTACK_KEY = 'pk_live_8d564a23f14efeda0cc5bdf2840799ccad436423';

      // Immediate client-side Paystack setup -> start downloads directly inside callback
      const handler = PaystackPop.setup({
        key: PAYSTACK_KEY,
        email,
        amount: amountKobo,
        ref: 'order_' + Date.now(),
        metadata: {
          custom_fields: [
            { display_name: "Cart", variable_name: "cart", value: JSON.stringify(cart) }
          ]
        },
        onClose: function() {
          document.getElementById('payment-msg').textContent = 'Payment window closed.';
          showToast('Payment closed');
        },
    callback: function(response) {
  // Get fresh cart
  const fallbackCart = readCart();
  document.getElementById('payment-msg').textContent = 'Payment completed — preparing downloads';
  showToast('Payment completed — ready to download');

  // Item -> files mapping (same as before)
  const itemFiles = {
    'marriage-honorable': [
      'https://drive.google.com/uc?export=download&id=1TerxB66O3f1zk4FrWSMyUJ2zIArkMQoF'
    ],
    // add other mappings...
  };

  // Build files list
  const files = [];
  (fallbackCart || []).forEach(it => {
    const id = it.id || it.productId || it.sku || (it.title && String(it.title).replace(/\s+/g,'-').toLowerCase());
    if (!id) return;
    const mapped = itemFiles[id];
    if (mapped && Array.isArray(mapped)) {
      mapped.forEach(url => { if (!files.includes(url)) files.push(url); });
    }
  });

  if (!files.length) {
    document.getElementById('payment-msg').textContent = 'Payment completed but no files found for your cart items.';
    showToast('No files found for your cart — contact support.');
    console.warn('No files mapped for cart', fallbackCart);
    return;
  }

  // Create a small download panel (in-page) so user can click to start downloads
  let panel = document.getElementById('download-panel');
  if (!panel) {
    panel = document.createElement('div');
    panel.id = 'download-panel';
    panel.style = 'position:fixed;left:50%;transform:translateX(-50%);bottom:28px;background:#fff;border-radius:8px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,0.15);z-index:10000;max-width:90vw;';
    document.body.appendChild(panel);
  }
  panel.innerHTML = `
    <div style="font-weight:600;margin-bottom:8px;">Your download is ready</div>
    <div id="download-links" style="max-height:180px;overflow:auto;margin-bottom:8px;"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="start-downloads" style="background:#D2B48C;color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;">Start downloads</button>
      <button id="close-downloads" style="padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;">Later</button>
    </div>
    <div style="margin-top:8px;font-size:12px;color:#666;">If automatic downloads fail, click any link below to download manually.</div>
  `;

  // populate manual links
  const linksEl = document.getElementById('download-links');
  linksEl.innerHTML = '';
  files.forEach((u, idx) => {
    const link = document.createElement('a');
    link.href = u;
    link.target = '_blank';
    link.rel = 'noopener noreferrer';
    link.textContent = `Download file ${idx + 1}`;
    link.style = 'display:block;padding:6px 0;color:#0645AD;text-decoration:underline;';
    linksEl.appendChild(link);
  });

  // Start downloads when user clicks the button (this click is a user gesture)
  document.getElementById('start-downloads').onclick = function() {
    // Attempt to open each file in a new tab (works when triggered by user click)
    files.forEach(url => {
      try {
        const a = document.createElement('a');
        a.href = url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        // For same-origin downloads you can set a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (e) {
        console.error('download error', e);
      }
    });

    // Clear cart, show status, close panel after a short pause
    clearCart();
    document.getElementById('payment-msg').textContent = 'Downloads started — thank you!';
    showToast('Downloads started');

    setTimeout(() => {
      const p = document.getElementById('download-panel');
      if (p) p.remove();
      // optional redirect
      // location.href = 'publications.html';
    }, 1400);
  };

  document.getElementById('close-downloads').onclick = function() {
    const p = document.getElementById('download-panel');
    if (p) p.remove();
    // keep cart cleared or not — your choice; we won't clear here
  };
}

      });
      handler.openIframe();
    });

    // Creates and clicks anchors to begin downloads
    function triggerDownloads(urls) {
      urls.forEach(url => {
        try {
          // open in new tab; for same-origin direct-download you can also set download attribute
          const a = document.createElement('a');
          a.href = url;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          document.body.appendChild(a);
          a.click();
          a.remove();
        } catch (e) {
          console.error('download error', e);
        }
      });
    }
    
  </script>
</body>
</html>
